- name: Connect to remote machine via SSH and perform actions
  hosts: all
  gather_facts: false
  vars:
      root_password: "@Ambula123!"
  tasks:
      - name: Install Git
        ansible.builtin.apt:
            name: git
            state: present
            update_cache: yes
        become: yes

      - name: Install Node.js 18.x
        import_role:
            name: nodesource.node
        vars:
            node_version: 18.x
            node_install_complementary: true
        become: yes

      - name: Install specific version of npm
        ansible.builtin.command:
            cmd: npm install -g npm@9.5.1
        become: yes
        become_user: root

      - name: Clone the repository
        ansible.builtin.git:
            repo: "https://github.com/ambula-labs/ambula-shell-output-api.git"
            dest: "/ambula-shell-output-api"
            clone: yes
            force: yes
            version: main
            accept_hostkey: yes
            update: yes
            depth: 1
        become: yes
        become_user: root # Change to root or another user with sufficient privileges

      - name: Install npm dependencies
        ansible.builtin.command:
            cmd: npm install
            chdir: /ambula-shell-output-api
        become: yes
        become_user: root

      - name: Start the application
        ansible.builtin.command:
            cmd: npm start
            chdir: /ambula-shell-output-api
        become: yes
        become_user: root
